#!/bin/bash

##################################################################################################
# hoobs-cli                                                                                      #
# Copyright (C) 2020 HOOBS                                                                       #
#                                                                                                #
# This program is free software: you can redistribute it and/or modify                           #
# it under the terms of the GNU General Public License as published by                           #
# the Free Software Foundation, either version 3 of the License, or                              #
# (at your option) any later version.                                                            #
#                                                                                                #
# This program is distributed in the hope that it will be useful,                                #
# but WITHOUT ANY WARRANTY; without even the implied warranty of                                 #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                                  #
# GNU General Public License for more details.                                                   #
#                                                                                                #
# You should have received a copy of the GNU General Public License                              #
# along with this program.  If not, see <http://www.gnu.org/licenses/>.                          #
##################################################################################################

CURRENT_DIRECTORY=$PWD

print_status() {
    if [[ "_$2" != "_" ]]; then
        echo "[$1] $2"
    else
        echo "$1"
    fi
}

get_os() {
    OS_BASE=$(uname | awk '{print tolower($0)}')
    OS_NAME="unknown"
    OS_CONTAINER=$(cat /proc/1/cgroup | grep 'docker\|lxc')

    if command -v python > /dev/null; then
        OS_PYTHON="python"
    elif command -v python3 > /dev/null; then
        OS_PYTHON="python3"
    else
        OS_PYTHON=""
    fi

    case $OS_BASE in
        "darwin")
            OS_NAME=$(sw_vers -productName | awk '{print tolower($0)}')
            ;;

        "linux")
            content=$(cat /etc/*-release | grep =)

            eval $content

            if [ "_$ID_LIKE" != "_" ]; then
                OS_NAME=$ID_LIKE
            else
                OS_NAME=$ID
            fi

            OS_NAME=${OS_NAME,,}
            ;;
    esac

    if command -v dnf > /dev/null; then
        OS_PACKAGE_MNGR="dnf"
    elif command -v yum > /dev/null; then
        OS_PACKAGE_MNGR="yum"
    elif command -v apt-get > /dev/null; then
        OS_PACKAGE_MNGR="apt-get"
    elif command -v apk > /dev/null; then
        OS_PACKAGE_MNGR="apk"
    fi
}

sudo uname > /dev/null
get_os

case $OS_NAME in
        "debian" | "raspbian" | "ubuntu")
            sudo apt install -y curl

            wget https://deb.nodesource.com/setup_lts.x

            chmod 755 ./setup_lts.x
            sudo ./setup_lts.x
            rm -f ./setup_lts.x

            curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
            echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list

            curl -sL https://repo.hoobs.org/debian/pubkey.gpg | sudo apt-key add -
            echo "deb https://repo.hoobs.org/debian/ buster main" | sudo tee /etc/apt/sources.list.d/hoobs.list

            sudo apt-get update
            source ~/.bashrc

            sudo apt update
            sudo apt install -y nodejs hoobs-cli hoobsd hoobs-gui

            sudo hbs install -p 80
            ;;
        
        * )
            print_status "[ ERROR ] operating system not supported"

            exit 1
            ;;
    esac

